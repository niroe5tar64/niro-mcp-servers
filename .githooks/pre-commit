#!/bin/sh
set -eu

ROOT="$(git rev-parse --show-toplevel)"
VALIDATOR="$ROOT/.codex/skills/claude-commands/scripts/quick_validate_bun.ts"

if [ ! -f "$VALIDATOR" ]; then
  echo "Validator not found: $VALIDATOR" >&2
  exit 1
fi

CHANGED="$(git diff --cached --name-only)"
if [ -z "$CHANGED" ]; then
  exit 0
fi

if command -v rg >/dev/null 2>&1; then
  SKILL_FILES="$(printf "%s\n" "$CHANGED" | rg '^\\.codex/skills/.+/SKILL\\.md$' || true)"
else
  SKILL_FILES="$(printf "%s\n" "$CHANGED" | grep -E '^\\.codex/skills/.+/SKILL\\.md$' || true)"
fi

if [ -z "$SKILL_FILES" ]; then
  exit 0
fi

printf "%s\n" "$SKILL_FILES" | while IFS= read -r rel_path; do
  [ -z "$rel_path" ] && continue
  skill_dir="$ROOT/$(dirname "$rel_path")"
  bun "$VALIDATOR" "$skill_dir"
done

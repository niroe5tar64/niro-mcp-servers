# デプロイ標準

[目的: 明確な環境とパイプラインパターンにより、安全で再現可能なリリースを行う]

## フィロソフィー
- 自動化し、デプロイ前にテストし、デプロイ後に検証する
- 迅速なロールバックが可能な段階的ロールアウトを優先する
- 本番変更は観測可能で、取り消し可能であること

## 環境
- Dev: 反復が速い、デバッグ有効
- Staging: 本番に近い、リリース検証
- Prod: 堅牢化、監視、最小権限

## CI/CD フロー
```
Code → Test → Build → Scan → Deploy (staged) → Verify
```
原則:
- テスト/スキャンで早期失敗し、デプロイをブロック
- 成果物は再現可能にする（ロックファイル、バージョン固定）
- 本番は手動承認、監査可能な履歴

## デプロイ戦略
- Rolling: インスタンスを段階的に入れ替え
- Blue-Green: 2 つのプール間でトラフィックを切り替え
- Canary: 小さい割合から開始し、健全性で拡大
リスクプロファイルに応じて選択し、デフォルトを文書化する。

## ゼロダウンタイム & マイグレーション
- ヘルスチェックでトラフィックを制御、グレースフルシャットダウン
- ロールアウト中は後方互換のある DB 変更
- マイグレーションは独立ステップ、ロールバック経路をテスト

## ロールバック
- 前バージョンを維持し、自動で戻せるようにする
- 修正よりロールバックが速い; トリガーを文書化

## 設定 & シークレット
- 12-factor の環境変数で設定; シークレットはコミットしない
- シークレットマネージャ、ローテーション、最小権限、アクセス監査
- 起動時に必須環境変数を検証

## ヘルス & 監視
- エンドポイント: `/health`, `/health/live`, `/health/ready`
- レイテンシ、エラーレート、スループット、飽和度を監視
- SLO 逸脱/スパイクでアラート。疲弊を避けるよう調整

## インシデント対応 & DR
- 標準プレイブック: 検知 → 評価 → 緩和 → 共有 → 解決 → 事後分析
- 保持期間付きのバックアップ; リストアを検証; RPO/RTO を定義

---
_ロールアウトパターンと安全策に集中する。プロバイダ固有手順は記載しない。_

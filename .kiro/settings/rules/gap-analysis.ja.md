# ギャップ分析プロセス

## 目的
要件と既存コードベースのギャップを分析し、実装方針の判断材料を提供する。

## 分析フレームワーク

### 1. 現状調査

- ドメイン関連資産の探索:
  - 主要ファイル/モジュールとディレクトリ構成
  - 再利用可能なコンポーネント/サービス/ユーティリティ
  - 支配的なアーキテクチャパターンと制約

- 規約の抽出:
  - 命名、レイヤリング、依存方向
  - import/export パターンと依存の集中箇所
  - テストの配置と手法

- 統合面の把握:
  - データモデル/スキーマ、API クライアント、認証メカニズム

### 2. 要件実現性の分析

- EARS 要件から技術的要求を列挙:
  - データモデル、API/サービス、UI/コンポーネント
  - ビジネスルール/検証
  - 非機能: セキュリティ、性能、スケーラビリティ、信頼性

- ギャップと制約の特定:
  - 既存コードベースに欠けている能力
  - 後続調査が必要な未知（"Research Needed" として記録）
  - 既存アーキテクチャとパターン由来の制約

- 複雑度シグナルの把握:
  - 単純 CRUD / アルゴリズムロジック / ワークフロー / 外部統合

### 3. 実装アプローチの選択肢

#### Option A: 既存コンポーネントの拡張
**適用条件**: 既存構造に自然に収まる機能

- **拡張対象のファイル/モジュール**:
  - 変更が必要な具体ファイルの特定
  - 既存機能への影響評価
  - 後方互換性の懸念点

- **互換性評価**:
  - 既存インターフェースとの整合性
  - 破壊的変更がないことの確認
  - テストカバレッジへの影響

- **複雑度と保守性**:
  - 追加機能による認知負荷
  - 単一責任原則の維持
  - ファイルサイズの健全性

**トレードオフ**:
- ✅ 新規ファイルが少なく、初期開発が速い
- ✅ 既存パターンと基盤を活用できる
- ❌ 既存コンポーネントの肥大化リスク
- ❌ 既存ロジックの複雑化

#### Option B: 新規コンポーネントの作成
**適用条件**: 明確に独立した責務があり、既存コンポーネントが複雑

- **新規作成の根拠**:
  - 関心の分離が明確に正当化される
  - 既存コンポーネントが既に複雑
  - 機能に独自のライフサイクルや依存がある

- **統合ポイント**:
  - 新規コンポーネントの既存システムとの接続方法
  - 公開する API やインターフェース
  - 既存コンポーネントへの依存

- **責務境界**:
  - 新規コンポーネントが所有する範囲の明確化
  - 既存コンポーネントとの境界
  - データフローと制御フロー

**トレードオフ**:
- ✅ 関心の分離が明確
- ✅ 分離してテストしやすい
- ✅ 既存コンポーネントの複雑度を抑制
- ❌ ファイル数が増える
- ❌ インターフェース設計が必要

#### Option C: ハイブリッド
**適用条件**: 拡張と新規作成が混在する複雑機能

- **組み合わせ戦略**:
  - どこを既存拡張にするか
  - どこを新規コンポーネントにするか
  - 相互作用の整理

- **段階的実装**:
  - 初期フェーズ: 最小限の変更
  - 後続フェーズ: リファクタリングまたは新規コンポーネント
  - 必要なら移行戦略

- **リスク緩和**:
  - 段階的ロールアウト
  - フィーチャーフラグや設定
  - ロールバック戦略

**トレードオフ**:
- ✅ 複雑機能に対してバランスが良い
- ✅ 反復的な改善が可能
- ❌ 計画が複雑になる
- ❌ 不整合リスク（調整不足の場合）

### 4. ギャップ分析の範囲外

- 深い調査は設計フェーズへ委ねる。
- 不明点は "Research Needed" として簡潔に記録する。

### 5. 実装の複雑度とリスク

  - 工数:
    - S (1–3 日): 既存パターン、依存最小、統合が容易
    - M (3–7 日): 新規パターン/統合が一部あり、中程度の複雑さ
    - L (1–2 週間): 大きな機能、複数統合やワークフロー
    - XL (2+ 週間): アーキテクチャ変更、未知技術、広範な影響
  - リスク:
    - 高: 未知技術、複雑統合、アーキテクチャ変更、性能/セキュリティの不確実性
    - 中: ガイダンス付き新規パターン、管理可能な統合、既知の性能策
    - 低: 既存パターンの拡張、馴染みの技術、明確な範囲、統合最小

### 出力チェックリスト

- 要件-資産マップ（ギャップは Missing / Unknown / Constraint を付与）
- Option A/B/C の簡潔な根拠とトレードオフ
- 工数（S/M/L/XL）とリスク（High/Medium/Low）の一言根拠
- 設計フェーズへの推奨:
  - 優先アプローチと主要判断
  - 継続調査事項

## 原則

- **判断より情報**: 最終判断ではなく分析と選択肢を示す
- **複数の選択肢**: 可能なら複数の妥当案を提示
- **ギャップと前提の明示**: 不明点と制約を明確に示す
- **文脈整合**: 既存パターンとアーキテクチャ制約に合わせる
- **工数とリスクの透明性**: ラベルに簡潔な根拠を付ける

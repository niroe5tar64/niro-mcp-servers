# データベース標準

[目的: スキーマ設計、クエリ、マイグレーション、整合性を導く]

## フィロソフィー
- まずドメインをモデル化し、正しさの後に最適化する
- 明示的な制約を優先し、DB に不変条件を担保させる
- 必要なものだけをクエリし、最適化前に計測する

## 命名 & 型
- テーブル: `snake_case`、複数形（`users`, `order_items`）
- カラム: `snake_case`（`created_at`, `user_id`）
- FK: `{table}_id` で `{table}.id` を参照
- 型: タイムゾーン付きタイムスタンプ、強い ID、正確な金額型

## リレーション
- 1:N: 子に FK
- N:N: 複合キーの中間テーブル
- 1:1: FK + UNIQUE

## マイグレーション
- 不変のマイグレーション; 常にロールバックを用意
- 小さく集中したステップ; 非本番で先にテスト
- 命名: `{seq}_{action}_{object}`（例: `002_add_email_index`）

## クエリパターン
- 簡易 CRUD と安全性は ORM、複雑/性能クリティカルは生 SQL
- N+1 を回避（Eager Load/バッチング）; 大きい集合はページング
- FK と頻繁なフィルタ/ソート列にインデックス

## 接続 & トランザクション
- プーリングを使用（サイズ/タイムアウトは負荷に応じて）
- 1 つの作業単位に 1 接続; 迅速にクローズ/返却
- 複数ステップ変更はトランザクションで包む

## データ整合性
- NOT NULL/UNIQUE/CHECK/FK 制約を使用
- 適切な箇所では DB でも検証（多層防御）
- 一貫した派生のため生成列を優先

## バックアップ & リカバリ
- 保持期間付きの定期バックアップ; リストアのテスト
- RPO/RTO 目標を文書化; バックアップジョブを監視

---
_パターンと判断に集中する。環境固有の設定は記載しない。_

---
description: ステージされた変更から、軽量な手順で適切なコミットメッセージを生成してコミットする
allowed-tools: Bash(git status:*), Bash(git diff:*), Bash(git log:*), Bash(git commit:*)
argument-hint: [追加メッセージ(オプション)]
---

# Git Commit Message Generator

## 目的
- 使用量制限に引っかかりにくい手順で、コミットメッセージを生成し、コミットを作成する。
- **全ファイルの全文 diff を最初から読まない**（重要）。

---

## タスク
以下の形式で適切なコミットメッセージを生成し、コミットを作成してください。

---

## コミットメッセージの形式

**1行目（サマリー）**
- Conventional Commits: `<type>: <subject>`
- type: feat / fix / refactor / docs / style / test / chore / perf
- subject: 日本語で簡潔に（変更内容の要約）

**本文（必要なら）**
- 箇条書きで「何を」「なぜ」を明確に
- ノイズ（自明な変更・整形だけ等）は省く

**フッター**
```
Co-Authored-By: <co-author>
```

---

## 実行手順

### Step 0: 追加メッセージ
ユーザーからの追加メッセージ（任意）:  
$ARGUMENTS

---

### Step 1: ステージ状況の確認（軽量）

1) `git status` でステージ有無を確認する  
- ステージされた変更が無ければ、その旨を報告して終了する。

2) **まずファイル一覧のみ取得する**
- `git diff --cached --name-only`

3) 変更規模をざっくり把握する
- `git diff --cached --shortstat`

4) 変更の偏りを確認する（自動整形・大量変更の判定）
- `git diff --cached --stat` を実行し、どのファイルに変更が集中しているかを確認する。
- 特定ファイルに変更が極端に集中している場合は、自動整形や機械的変更の可能性が高い。
- この結果を、Step 2 の「読む範囲の判断」および Step 3 の「最大3ファイル選定」に利用する。

---

### Step 2: diff を読む範囲を決める（重要）

- 原則：**必要最小限のファイルだけ** `git diff --cached -- <file>` で読む。
- **禁止事項**: `git diff --cached`（ファイル指定なしの全文 diff）は実行しない。

#### ルールA（小規模）
- 変更ファイル数が **1〜5** 程度
- shortstat が小さめ（目安: 〜100行前後）

→ 変更ファイルを順に `git diff --cached -- <file>` で確認してよい。

#### ルールB（中〜大規模）
- 変更ファイル数が多い（例: 6以上）  
- shortstat が大きい（例: 数百行以上）  
- フォーマット / 自動整形の可能性が高い  

→ **全文精読しない**。Step 3 の「要約モード」に切り替える。

---

### Step 3: 要約モード（トークン節約）

中〜大規模の場合は、この順で処理する：

1) `git diff --cached --name-status` で変更タイプ（A/M/D/R）を把握する  
2) **変更の核になりそうなファイルを最大3つまで選ぶ**  
   - 選んだファイルのみ `git diff --cached -- <file>` を実行する
3) 残りの変更は、ファイル名と変更タイプから推測し、**確実に言える範囲でのみ**本文に反映する  
   - 断定できない詳細は書かない（例:「微調整」程度に留める）

---

### Step 4: コミット履歴の参照（任意・軽量）
- style の確認が必要な場合のみ実行する
- `git log --oneline -3`
- 不要な場合はスキップしてよい

---

## メッセージ作成ルール（重要）

### ステージ見直しの提案（重要）

- ステージされた変更が複数の目的（例: 機能追加とバグ修正、リファクタと整形）に混在しており、1コミットの subject が曖昧になりそうな場合は、**コミットを実行しない**。
- 代わりに、チャット上で「ステージを分け直す」提案を短く提示して終了する。
  - 例: `git reset -p` / `git add -p`
- このコマンド内では、ステージ操作（reset / add）は行わない（提案のみ）。
- ユーザーが「今回はまとめてOK」と明示した場合のみ、最重要の変更に寄せて1コミットで作成してよい。

---

### type 判定ガイド
- feat: 新機能・新しいふるまい
- fix: バグ修正
- refactor: ふるまい変更なしの設計改善
- docs: ドキュメント
- style: フォーマットのみ（ロジック変更なし）
- test: テスト関連
- chore: 雑務（依存更新、設定、CI、生成物など）
- perf: パフォーマンス改善

---

### subject の書き方
- 「〜を追加」「〜を修正」「〜を改善」「〜を更新」など、短く断定的に
- 例: `feat: 検索結果にファセットを追加`
- 例: `fix: ログイン時のリダイレクト不具合を修正`

---

### 本文に書くべき事柄
- 変更が複数点ある
- 理由（なぜ）が重要
- 影響範囲がある（例: API変更、互換性、移行）

### 本文に書かない方がいい事柄
- 小さなリネームのみ
- 整形のみ
- 自明な修正のみ

---

## コミット実行

- 作成したコミットメッセージを **実行前にチャット上で短く提示**する。
- ステージ見直しの提案がない場合は、以下の形式で `git commit` を実行する。

```bash
git commit -F - <<'EOF'
<type>: <subject>

- 変更点（必要なら）

Co-Authored-By: <co-auther>
EOF
```

## 最後に

- ユーザーの追加メッセージ（`$ARGUMENTS`）がある場合は、**subject および本文に反映**する。

